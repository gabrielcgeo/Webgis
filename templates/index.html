{% extends "base.html" %}
{% block title %}{{ company.name }}{% endblock %}
{% block head %}
<style>
    #map { height: calc(100vh - 56px); width: 100vw; margin: 0; padding: 0; left: 0; position: fixed;}
    .content-body { height: calc(100vh - 56px); }
    .container-fluid.mt-2 { display: none; }
    .info-panel { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2); max-height: calc(100vh - 80px); overflow-y: auto; max-width: 300px; }
    .modal-dialog { max-width: 80%; }
</style>
{% endblock %}
{% block content %}
<div id="map"></div>
<div class="info-panel" id="info-panel">
    </div>
<div class="modal fade" id="info-modal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="info-modal-title"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="info-modal-body"></div></div></div></div>
{% endblock %}
{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const companySlug = {{ company.slug|tojson }};
        if (!companySlug) return;

        const map = L.map('map').setView([-15.79, -47.88], 4);
        const basemaps = {
            'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map),
            'Sat√©lite': L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']})
        };
        const activeLayers = {};
        const layerControl = L.control.layers(basemaps, activeLayers, { position: 'topleft' }).addTo(map);
        
        const infoPanel = document.getElementById('info-panel');
        infoPanel.innerHTML = `<h4>Camadas</h4><div id="layer-list-container">Carregando...</div>`;

        fetch(`/portal/${companySlug}/api/camadas`)
            .then(response => response.json())
            .then(projects => {
                const container = document.getElementById('layer-list-container');
                container.innerHTML = '';
                for (const projectName in projects) {
                    const projectDiv = document.createElement('div');
                    projectDiv.innerHTML = `<h5 class="mt-2">${projectName}</h5>`;
                    const layerList = document.createElement('ul');
                    layerList.className = 'list-unstyled';
                    projects[projectName].forEach(layer => {
                        const layerItem = document.createElement('li');
                        layerItem.innerHTML = `<input type="checkbox" id="layer-${layer.name}"> <label for="layer-${layer.name}">${layer.name} (${layer.theme})</label>`;
                        layerList.appendChild(layerItem);
                    });
                    projectDiv.appendChild(layerList);
                    container.appendChild(projectDiv);
                }
            });
    });
</script>
{% endblock %}