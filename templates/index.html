{% extends "base.html" %}
{% block title %}{{ company.name }}{% endblock %}
{% block head %}
<style>
    #map { height: calc(100vh - 56px); width: 100vw; margin: 0; padding: 0; left: 0; position: fixed;}
    .content-body { height: calc(100vh - 56px); }
    .info-panel { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2); max-height: calc(100vh - 80px); overflow-y: auto; max-width: 300px; }
    .modal-dialog { max-width: 80%; }
</style>
{% endblock %}
{% block content %}
<div id="map"></div>
<div class="info-panel" id="info-panel">
    <h4>Camadas</h4>
    <div id="layer-list-container">Carregando...</div>
</div>
{% endblock %}
{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const companySlug = {{ company.slug|tojson }};
        if (!companySlug) return;
        
        const map = L.map('map').setView([-15.79, -47.88], 4);
        const basemaps = {
            'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map),
            'SatÃ©lite': L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']})
        };
        const activeLayers = {};
        const layerControl = L.control.layers(basemaps, activeLayers, { position: 'topleft' }).addTo(map);
        
        fetch(`/portal/${companySlug}/api/camadas`)
            .then(response => response.json())
            .then(projects => {
                const container = document.getElementById('layer-list-container');
                container.innerHTML = '';
                if (Object.keys(projects).length === 0) {
                    container.innerHTML = '<p class="text-muted"><small>Nenhuma camada encontrada.</small></p>';
                    return;
                }
                for (const projectName in projects) {
                    const projectDiv = document.createElement('div');
                    projectDiv.innerHTML = `<h5 class="mt-2">${projectName}</h5>`;
                    const layerList = document.createElement('ul');
                    layerList.className = 'list-unstyled ps-2';
                    projects[projectName].forEach(layer => {
                        const layerItem = document.createElement('li');
                        layerItem.innerHTML = `<input type="checkbox" id="layer-${layer.name}"> <label for="layer-${layer.name}">${layer.name} (${layer.theme})</label>`;
                        layerList.appendChild(layerItem);
                    });
                    projectDiv.appendChild(layerList);
                    container.appendChild(projectDiv);
                }
            });
    });
</script>
{% endblock %}