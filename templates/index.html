{% extends "base.html" %}
{% block title %}{{ company.name }}{% endblock %}
{% block head %}
<style>
    #map { height: calc(100vh - 56px); width: 100vw; margin: 0; padding: 0; left: 0; position: fixed;}
    .content-body { height: calc(100vh - 56px); }
    .info-panel { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2); max-height: calc(100vh - 80px); overflow-y: auto; max-width: 320px; }
    .modal-dialog { max-width: 80%; }
    .table-responsive { max-height: 60vh; overflow-y: auto; }
</style>
{% endblock %}
{% block content %}
<div id="map"></div>
<div class="info-panel" id="info-panel">
    </div>
<div class="modal fade" id="info-modal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="info-modal-title"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="info-modal-body"></div></div></div></div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const companySlug = {{ company.slug|tojson }};
        if (!companySlug) return;

        const map = L.map('map');
        const infoModal = new bootstrap.Modal(document.getElementById('info-modal'));
        let activeVectorLayers = {};
        let basemaps, layerControl;

        // --- SETUP DO MAPA E CONTROLES ---
        function setupMap() {
            const initialParams = {}; // Placeholder para a lógica de URL Hash
            map.setView([initialParams.lat || -15.79, initialParams.lng || -47.88], initialParams.zoom || 4);

            basemaps = {
                'Google Híbrido': L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google'}),
                'Google Ruas': L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google'}),
                'Esri Satélite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: 'Esri'}),
                'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: 'OpenStreetMap'}),
            };
            basemaps[initialParams.base || 'Google Híbrido'].addTo(map);

            layerControl = L.control.layers(basemaps, {}, { position: 'bottomright' }).addTo(map);
            L.control.scale({ imperial: false, position: 'bottomcenter' }).addTo(map);

            fetchAndDisplayLayers(initialParams.layers);
        }

        function fetchAndDisplayLayers(layersToActivate = []) {
            fetch(`/portal/${companySlug}/api/camadas`)
                .then(response => response.json())
                .then(projects => {
                    const container = document.getElementById('layer-list-container') || document.createElement('div');
                    container.id = 'layer-list-container';
                    container.innerHTML = ''; // Limpa o conteúdo

                    if (Object.keys(projects).length === 0) {
                        container.innerHTML = '<p class="text-muted"><small>Nenhuma camada encontrada.</small></p>';
                        return;
                    }

                    for (const projectName in projects) {
                        const projectDiv = document.createElement('div');
                        projectDiv.innerHTML = `<h5 class="mt-2">${projectName}</h5>`;
                        const layerList = document.createElement('ul');
                        layerList.className = 'list-unstyled ps-2';
                        projects[projectName].forEach(layerData => {
                            const layerItem = document.createElement('li');
                            layerItem.innerHTML = `
                                <input type="checkbox" id="layer-${layerData.id}" onchange="toggleLayer(${layerData.id}, '${layerData.name}')">
                                <label for="layer-${layerData.id}">${layerData.name}</label>
                                `;
                            layerList.appendChild(layerItem);
                        });
                        projectDiv.appendChild(layerList);
                        container.appendChild(projectDiv);
                    }
                    infoPanel.innerHTML = '<h4>Camadas</h4>';
                    infoPanel.appendChild(container);
                });
        }

        window.toggleLayer = function(layerId, layerName) {
            const isChecked = document.getElementById(`layer-${layerId}`).checked;
            if(isChecked) {
                if(activeVectorLayers[layerName]) return; // Já está no mapa
                fetchLayerData(layerId, layerName);
            } else {
                if(activeVectorLayers[layerName]) {
                    map.removeLayer(activeVectorLayers[layerName].layer);
                    layerControl.removeLayer(activeVectorLayers[layerName].layer);
                    delete activeVectorLayers[layerName];
                }
            }
        }

        function fetchLayerData(layerId, layerName){
             fetch(`/portal/${companySlug}/api/camada_data/${layerId}`)
                .then(r => r.json())
                .then(geojson => {
                    const layer = L.geoJson(geojson, {
                        onEachFeature: (feature, l) => {
                            let content = '<h6>Atributos</h6><div class="table-responsive"><table class="table table-sm table-bordered">';
                            for (const key in feature.properties) {
                                content += `<tr><th>${key}</th><td>${feature.properties[key]}</td></tr>`;
                            }
                            content += '</table></div>';
                            l.bindPopup(content);
                        }
                    }).addTo(map);
                    activeVectorLayers[layerName] = { layer: layer, id: layerId };
                    layerControl.addOverlay(layer, layerName);
                });
        }

        setupMap();
    });
</script>
{% endblock %}