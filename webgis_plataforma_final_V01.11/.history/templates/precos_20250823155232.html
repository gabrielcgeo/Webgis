{% extends 'layout.html' %}

{% block content %}
<style>
/* Estilos para a página de preços */
.pricing-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    border-radius: 15px;
}

.pricing-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.pricing-card.featured {
    border: 3px solid #0d6efd;
    transform: scale(1.05);
}

.pricing-card.featured:hover {
    transform: scale(1.05) translateY(-5px);
}

.plan-price {
    font-size: 3rem;
    font-weight: bold;
    color: #0d6efd;
}

.plan-features {
    list-style: none;
    padding: 0;
}

.plan-features li {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.plan-features li:before {
    content: "✓";
    color: #28a745;
    font-weight: bold;
    margin-right: 10px;
}

.calculator-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 3rem;
}

.breakdown-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
}

.breakdown-item:hover {
    background-color: #f8f9fa;
}

.result-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}

.feature-icon {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: #0d6efd;
}
</style>

<div class="container-fluid">
    <!-- Header da Página -->
    <div class="text-center py-5 mb-5">
        <h1 class="display-4 text-primary mb-3">
            <i class="fas fa-tags me-3"></i>Preços e Planos WebGIS
        </h1>
        <p class="lead text-muted">Escolha o plano ideal para sua empresa ou calcule um preço personalizado</p>
    </div>

    <!-- Seção de Planos -->
    <div class="row mb-5">
        <div class="col-12">
            <h2 class="text-center mb-4">
                <i class="fas fa-rocket me-2"></i>Planos Disponíveis
            </h2>
        </div>
        
        <!-- Plano Starter -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card pricing-card h-100">
                <div class="card-header text-center bg-light">
                    <h4 class="mb-0">
                        <i class="fas fa-seedling text-success me-2"></i>Starter
                    </h4>
                    <p class="text-muted mb-0">Ideal para pequenas empresas</p>
                </div>
                <div class="card-body text-center">
                    <div class="mb-2" id="starter-original-price" style="display: none;">
                        <span class="text-muted text-decoration-line-through" style="font-size: 1.5rem;"></span>
                    </div>
                    <div class="plan-price mb-2" id="starter-price">Carregando...</div>
                    <div class="mb-3" id="starter-discount" style="display: none;">
                        <span class="badge bg-success fs-6"></span>
                    </div>
                    <p class="text-muted">por mês</p>
                    <ul class="plan-features text-start">
                        <li>Até 5 projetos</li>
                        <li>Até 50 camadas</li>
                        <li>Até 100 mapas públicos</li>
                        <li>Até 10.000 visualizações/mês</li>
                        <li>Até 5 funcionários</li>
                        <li>Até <span id="starter-storage">50 GB</span> de armazenamento</li>
                        <li>Suporte por email</li>
                    </ul>
                </div>
                <div class="card-footer text-center">
                    <a href="{{ url_for('login') }}" class="btn btn-outline-primary btn-lg w-100">
                        <i class="fas fa-rocket me-2"></i>Começar Agora
                    </a>
                </div>
            </div>
        </div>

        <!-- Plano Professional (Featured) -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card pricing-card featured h-100">
                <div class="card-header text-center bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-star text-warning me-2"></i>Professional
                    </h4>
                    <p class="mb-0">Mais popular</p>
                </div>
                <div class="card-body text-center">
                    <div class="mb-2" id="professional-original-price" style="display: none;">
                        <span class="text-muted text-decoration-line-through" style="font-size: 1.5rem;"></span>
                    </div>
                    <div class="plan-price mb-2" id="professional-price">Carregando...</div>
                    <div class="mb-3" id="professional-discount" style="display: none;">
                        <span class="badge bg-success fs-6"></span>
                    </div>
                    <p class="text-muted">por mês</p>
                    <ul class="plan-features text-start">
                        <li>Até 25 projetos</li>
                        <li>Até 250 camadas</li>
                        <li>Até 500 mapas públicos</li>
                        <li>Até 100.000 visualizações/mês</li>
                        <li>Até 15 funcionários</li>
                        <li>Até <span id="professional-storage">500 GB</span> de armazenamento</li>
                        <li>Suporte prioritário</li>
                        <li>Funcionalidades avançadas</li>
                    </ul>
                </div>
                <div class="card-footer text-center">
                    <a href="{{ url_for('login') }}" class="btn btn-primary btn-lg w-100">
                        <i class="fas fa-crown me-2"></i>Escolher Professional
                    </a>
                </div>
            </div>
        </div>

        <!-- Plano Enterprise -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card pricing-card h-100">
                <div class="card-header text-center bg-dark text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-building text-info me-2"></i>Enterprise
                    </h4>
                    <p class="text-muted mb-0">Para grandes corporações</p>
                </div>
                <div class="card-body text-center">
                    <div class="mb-2" id="enterprise-original-price" style="display: none;">
                        <span class="text-muted text-decoration-line-through" style="font-size: 1.5rem;"></span>
                    </div>
                    <div class="plan-price mb-2" id="enterprise-price">Carregando...</div>
                    <div class="mb-3" id="enterprise-discount" style="display: none;">
                        <span class="badge bg-success fs-6"></span>
                    </div>
                    <div class="mb-2" id="enterprise-tier-discount" style="display: none;">
                        <small class="text-success">
                            <i class="fas fa-tags me-1"></i>
                            <span id="enterprise-discount-amount"></span> em desconto por volume
                        </small>
                    </div>
                    <p class="text-muted">por mês</p>
                    <ul class="plan-features text-start">
                        <li>Até 150 projetos</li>
                        <li>Até 1.000 camadas</li>
                        <li>Até 5.000 mapas públicos</li>
                        <li>Até 500.000 visualizações/mês</li>
                        <li>Até 100 funcionários</li>
                        <li>Até <span id="enterprise-storage">1.000 GB</span> de armazenamento</li>
                        <li>Suporte 24/7</li>
                        <li>Funcionalidades premium</li>
                        <li>Relatórios avançados</li>
                    </ul>
                </div>
                <div class="card-footer text-center">
                    <a href="{{ url_for('login') }}" class="btn btn-dark btn-lg w-100">
                        <i class="fas fa-phone me-2"></i>Falar com Vendas
                    </a>
                </div>
            </div>
        </div>

        <!-- Plano Personalizado -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card pricing-card h-100">
                <div class="card-header text-center bg-warning text-dark">
                    <h4 class="mb-0">
                        <i class="fas fa-cogs text-primary me-2"></i>Personalizado
                    </h4>
                    <p class="text-muted mb-0">Sob medida para você</p>
                </div>
                <div class="card-body text-center">
                    <div class="mb-2" id="custom-original-price" style="display: none;">
                        <span class="text-muted text-decoration-line-through" style="font-size: 1.5rem;"></span>
                    </div>
                    <div class="plan-price mb-2" id="custom-price">R$ 0,00</div>
                    <div class="mb-3" id="custom-discount" style="display: none;">
                        <span class="badge bg-success fs-6"></span>
                    </div>
                    <p class="text-muted">por mês</p>
                    <ul class="plan-features text-start">
                        <li id="custom-projects">Projetos personalizados</li>
                        <li id="custom-layers">Camadas personalizadas</li>
                        <li id="custom-maps">Mapas públicos personalizados</li>
                        <li id="custom-views">Visualizações personalizadas</li>
                        <li id="custom-employees">Funcionários personalizados</li>
                        <li id="custom-storage">Armazenamento personalizado</li>
                        <li>Suporte personalizado</li>
                        <li>Recursos sob medida</li>
                        <li>Integrações específicas</li>
                    </ul>
                </div>
                <div class="card-footer text-center">
                    <button type="button" class="btn btn-warning btn-lg w-100" onclick="scrollToCalculator()">
                        <i class="fas fa-calculator me-2"></i>Calcular Preço
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção da Calculadora -->
    <div class="calculator-section">
        <div class="row">
            <div class="col-12 text-center mb-4">
                <h2 class="text-white">
                    <i class="fas fa-calculator me-3"></i>Calculadora Personalizada
                </h2>
                <p class="text-white-50">Calcule o preço exato para suas necessidades específicas</p>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-body">
                        <form id="pricingForm">
                            <div class="row">
                                <!-- Coluna 1 -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="projects" class="form-label">
                                            <i class="fas fa-project-diagram text-primary me-2"></i>Número de Projetos
                                        </label>
                                        <input type="number" class="form-control" id="projects" min="0" value="5">
                                        <small class="form-text text-muted">Projetos para organizar suas camadas</small>
                                    </div>

                                    <div class="mb-3">
                                        <label for="layers" class="form-label">
                                            <i class="fas fa-layer-group text-success me-2"></i>Número de Camadas
                                        </label>
                                        <input type="number" class="form-control" id="layers" min="0" value="100">
                                        <small class="form-text text-muted">Shapefiles, GeoTIFFs, KMLs, etc.</small>
                                    </div>

                                    <div class="mb-3">
                                        <label for="public_maps" class="form-label">
                                            <i class="fas fa-globe-americas text-info me-2"></i>Mapas Públicos
                                        </label>
                                        <input type="number" class="form-control" id="public_maps" min="0" value="10">
                                        <small class="form-text text-muted">Mapas compartilhados publicamente</small>
                                    </div>
                                </div>

                                <!-- Coluna 2 -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="page_views" class="form-label">
                                            <i class="fas fa-eye text-warning me-2"></i>Visualizações/Mês
                                        </label>
                                        <input type="number" class="form-control" id="page_views" min="0" value="50000">
                                        <small class="form-text text-muted">Acessos aos mapas públicos</small>
                                    </div>

                                    <div class="mb-3">
                                        <label for="employees" class="form-label">
                                            <i class="fas fa-users text-secondary me-2"></i>Funcionários Cadastrados
                                        </label>
                                        <input type="number" class="form-control" id="employees" min="0" value="15">
                                        <small class="form-text text-muted">Usuários com acesso à plataforma</small>
                                    </div>

                                    <div class="mb-3">
                                        <label for="server_usage" class="form-label">
                                            <i class="fas fa-server text-danger me-2"></i>Uso do Servidor (GB)
                                        </label>
                                        <input type="number" class="form-control" id="server_usage" min="0" step="0.1" value="50">
                                        <small class="form-text text-muted">Armazenamento + transferência de dados</small>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-12 text-center">
                                    <button type="button" class="btn btn-primary btn-lg" onclick="calculatePrice()">
                                        <i class="fas fa-calculator me-2"></i>Calcular Preço
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary ms-2" onclick="resetForm()">
                                        <i class="fas fa-undo me-2"></i>Limpar
                                    </button>
                                </div>
                            </div>
                        </form>

                        <!-- Loading -->
                        <div id="pricing-loading" class="text-center mt-4" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Calculando...</span>
                            </div>
                            <p class="mt-2 text-muted">Calculando preços...</p>
                        </div>

                        <!-- Resultado -->
                        <div id="pricing-result" class="mt-4" style="display: none;">
                            <div class="result-card">
                                <div class="card-header bg-success text-white text-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-line me-2"></i>Resultado do Cálculo
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-md-6">
                                            <div class="border-end">
                                                <h6 class="text-muted">Preço Mensal</h6>
                                                <h3 class="text-success" id="total-price">R$ 0,00</h3>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-muted">Preço Anual</h6>
                                            <h4 class="text-info" id="annual-price">R$ 0,00</h4>
                                        </div>
                                    </div>

                                    <div class="mt-4">
                                        <div id="price-breakdown"></div>
                                    </div>

                                    <!-- Recomendação de Plano -->
                                    <div class="mt-4 text-center">
                                        <div id="plan-recommendation"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção de Recursos -->
    <div class="row mt-5">
        <div class="col-12 text-center mb-4">
            <h2>
                <i class="fas fa-star me-2"></i>Por que escolher o WebGIS?
            </h2>
        </div>
        
        <div class="col-md-4 text-center mb-4">
            <div class="feature-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h4>Segurança</h4>
            <p class="text-muted">Infraestrutura segura com backup automático e criptografia de dados</p>
        </div>
        
        <div class="col-md-4 text-center mb-4">
            <div class="feature-icon">
                <i class="fas fa-tachometer-alt"></i>
            </div>
            <h4>Performance</h4>
            <p class="text-muted">Servidores de alta performance com 99.9% de uptime garantido</p>
        </div>
        
        <div class="col-md-4 text-center mb-4">
            <div class="feature-icon">
                <i class="fas fa-headset"></i>
            </div>
            <h4>Suporte</h4>
            <p class="text-muted">Equipe técnica especializada disponível para ajudar sua empresa</p>
        </div>
    </div>

    <!-- CTA Final -->
    <div class="row mt-5">
        <div class="col-12 text-center">
            <div class="card bg-primary text-white">
                <div class="card-body py-5">
                    <h2 class="mb-3">Pronto para começar?</h2>
                    <p class="lead mb-4">Junte-se a centenas de empresas que já confiam no WebGIS</p>
                    <div class="d-flex gap-3 justify-content-center">
                        <a href="{{ url_for('login') }}" class="btn btn-light btn-lg">
                            <i class="fas fa-rocket me-2"></i>Começar Agora
                        </a>
                        <a href="#calculator" class="btn btn-outline-light btn-lg">
                            <i class="fas fa-calculator me-2"></i>Calcular Preço
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para a Calculadora -->
<script>
// Verificar se as funções de formatação estão disponíveis
function verificarFuncoesFormatacao() {
    if (typeof formatarMoeda === 'undefined') {
        console.error('Função formatarMoeda não encontrada');
        return false;
    }
    if (typeof formatarNumero === 'undefined') {
        console.error('Função formatarNumero não encontrada');
        return false;
    }
    if (typeof formatarPercentual === 'undefined') {
        console.error('Função formatarPercentual não encontrada');
        return false;
    }
    if (typeof formatarArmazenamentoInteligente === 'undefined') {
        console.error('Função formatarArmazenamentoInteligente não encontrada');
        return false;
    }
    return true;
}

async function calculatePrice() {
    console.log('Função calculatePrice chamada');
    const form = document.getElementById('pricingForm');
    const resultDiv = document.getElementById('pricing-result');
    const loadingDiv = document.getElementById('pricing-loading');
    
    // Verificar se todos os elementos necessários existem
    if (!form) {
        console.error('Formulário não encontrado');
        alert('Erro: Formulário da calculadora não encontrado');
        return;
    }
    
    if (!resultDiv) {
        console.error('Div de resultado não encontrada');
        alert('Erro: Área de resultado não encontrada');
        return;
    }
    
    if (!loadingDiv) {
        console.error('Div de loading não encontrada');
        alert('Erro: Área de carregamento não encontrada');
        return;
    }
    
    // Mostrar loading
    loadingDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    
    const data = {
        projects: parseInt(document.getElementById('projects').value) || 0,
        layers: parseInt(document.getElementById('layers').value) || 0,
        public_maps: parseInt(document.getElementById('public_maps').value) || 0,
        page_views: parseInt(document.getElementById('page_views').value) || 0,
        employees: parseInt(document.getElementById('employees').value) || 0,
        server_usage: parseFloat(document.getElementById('server_usage').value) || 0
    };
    
    console.log('Dados para cálculo:', data);
    
    try {
        const response = await fetch('/api/pricing/calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        console.log('Resposta da API:', response);
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Resultado da API:', result);
        displayResult(result);
        
        // Salvar valores da calculadora após cálculo bem-sucedido
        salvarValoresCalculadora();
        
    } catch (error) {
        console.error('Erro na função calculatePrice:', error);
        alert(`Erro ao calcular preços: ${error.message}`);
    } finally {
        if (loadingDiv) {
            loadingDiv.style.display = 'none';
        }
    }
}

function displayResult(result) {
    console.log('Função displayResult chamada com:', result);
    const totalPriceElement = document.getElementById('total-price');
    const breakdownElement = document.getElementById('price-breakdown');
    const resultDiv = document.getElementById('pricing-result');
    const planRecommendationElement = document.getElementById('plan-recommendation');
    
    if (!totalPriceElement || !breakdownElement || !resultDiv) {
        console.error('Elementos de resultado não encontrados');
        return;
    }
    
    // Formatar preço total
    totalPriceElement.textContent = formatarMoeda(result.total_cost);
    
    // Atualizar preços anuais
    const annualPriceElement = document.getElementById('annual-price');
    if (annualPriceElement) {
        const annualPrice = result.total_cost * 12;
        annualPriceElement.textContent = formatarMoeda(annualPrice);
    }
    
    // Criar breakdown com descontos por tier
    let breakdownHTML = '<h6>Detalhamento dos Custos:</h6>';
    
    const labels = {
        'projects': 'Projetos',
        'layers': 'Camadas', 
        'public_maps': 'Mapas Públicos',
        'page_views': 'Visualizações',
        'employees': 'Funcionários',
        'server_usage': 'Servidor'
    };
    
    for (const [key, item] of Object.entries(result.breakdown)) {
        if (item.weighted_cost > 0) {
            breakdownHTML += `
                <div class="breakdown-item">
                    <span><strong>${labels[key]}:</strong></span>
                    <span class="text-success">${formatarMoeda(item.weighted_cost)}</span>
                </div>
            `;
        }
    }
    
    // Mostrar total de desconto por tier se disponível
    if (result.total_tier_discount > 0) {
        breakdownHTML += `
            <div class="breakdown-item bg-success bg-opacity-10">
                <span><strong>Total de Desconto por Volume:</strong></span>
                <span class="text-success fw-bold">${formatarMoeda(result.total_tier_discount)}</span>
            </div>
        `;
    }
    
    breakdownElement.innerHTML = breakdownHTML;
    
    // Gerar recomendação de plano
    if (planRecommendationElement) {
        generatePlanRecommendation(result.total_cost, planRecommendationElement);
    }
    
    // Atualizar plano personalizado com os valores calculados
    atualizarPlanoPersonalizado(result);
    
    resultDiv.style.display = 'block';
    console.log('Resultado exibido com sucesso');
}

function generatePlanRecommendation(totalCost, element) {
    let recommendation = '';
    let planClass = '';
    
    // Usar os mesmos valores dos planos para consistência
    if (totalCost <= 1055) { // Starter: R$ 1.055,36
        recommendation = 'Recomendamos o plano <strong>Starter</strong> para suas necessidades atuais.';
        planClass = 'text-success';
    } else if (totalCost <= 6278) { // Professional: R$ 6.278,86
        recommendation = 'Recomendamos o plano <strong>Professional</strong> para suas necessidades atuais.';
        planClass = 'text-primary';
    } else {
        recommendation = 'Recomendamos o plano <strong>Enterprise</strong> para suas necessidades atuais.';
        planClass = 'text-dark';
    }
    
    element.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-lightbulb me-2"></i>
            <span class="${planClass}">${recommendation}</span>
        </div>
    `;
}

function resetForm() {
    console.log('Função resetForm chamada');
    document.getElementById('pricingForm').reset();
    document.getElementById('pricing-result').style.display = 'none';
    document.getElementById('pricing-loading').style.display = 'none';
    
    // Restaurar valores padrão
    document.getElementById('projects').value = '5';
    document.getElementById('layers').value = '100';
    document.getElementById('public_maps').value = '10';
    document.getElementById('page_views').value = '50000';
    document.getElementById('employees').value = '15';
    document.getElementById('server_usage').value = '50';
    
    // Salvar valores padrão no localStorage
    salvarValoresCalculadora();
    
    // Limpar plano personalizado
    limparPlanoPersonalizado();
}

// Função para atualizar o plano personalizado com os valores calculados
function atualizarPlanoPersonalizado(result) {
    // Atualizar preço
    const customPriceElement = document.getElementById('custom-price');
    if (customPriceElement) {
        customPriceElement.textContent = formatarMoeda(result.total_cost);
    }
    
    // Atualizar detalhes do plano
    const customProjects = document.getElementById('custom-projects');
    const customLayers = document.getElementById('custom-layers');
    const customMaps = document.getElementById('custom-maps');
    const customViews = document.getElementById('custom-views');
    const customEmployees = document.getElementById('custom-employees');
    const customStorage = document.getElementById('custom-storage');
    
    if (customProjects) customProjects.textContent = `${formatarNumero(result.breakdown.projects?.quantity || 0)} projetos`;
    if (customLayers) customLayers.textContent = `${formatarNumero(result.breakdown.layers?.quantity || 0)} camadas`;
    if (customMaps) customMaps.textContent = `${formatarNumero(result.breakdown.public_maps?.quantity || 0)} mapas públicos`;
    if (customViews) customViews.textContent = `${formatarNumero(result.breakdown.page_views?.quantity || 0)} visualizações/mês`;
    if (customEmployees) customEmployees.textContent = `${formatarNumero(result.breakdown.employees?.quantity || 0)} funcionários`;
    if (customStorage) customStorage.textContent = `${formatarArmazenamentoInteligente(result.breakdown.server_usage?.quantity || 0)} de armazenamento`;
    
    // Mostrar desconto se aplicável
    const customDiscountElement = document.getElementById('custom-discount');
    if (customDiscountElement && result.total_tier_discount > 0) {
        const spanElement = customDiscountElement.querySelector('span');
        if (spanElement) {
            spanElement.textContent = `${formatarMoeda(result.total_tier_discount)} de desconto por volume`;
            customDiscountElement.style.display = 'block';
        }
    }
}

// Função para limpar o plano personalizado
function limparPlanoPersonalizado() {
    const customPriceElement = document.getElementById('custom-price');
    if (customPriceElement) {
        customPriceElement.textContent = 'R$ 0,00';
    }
    
    // Restaurar texto padrão dos itens
    const customProjects = document.getElementById('custom-projects');
    const customLayers = document.getElementById('custom-layers');
    const customMaps = document.getElementById('custom-maps');
    const customViews = document.getElementById('custom-views');
    const customEmployees = document.getElementById('custom-employees');
    const customStorage = document.getElementById('custom-storage');
    
    if (customProjects) customProjects.textContent = 'Projetos personalizados';
    if (customLayers) customLayers.textContent = 'Camadas personalizadas';
    if (customMaps) customMaps.textContent = 'Mapas públicos personalizados';
    if (customViews) customViews.textContent = 'Visualizações personalizadas';
    if (customEmployees) customEmployees.textContent = 'Funcionários personalizados';
    if (customStorage) customStorage.textContent = 'Armazenamento personalizado';
    
    // Ocultar desconto
    const customDiscountElement = document.getElementById('custom-discount');
    if (customDiscountElement) {
        customDiscountElement.style.display = 'none';
    }
}

// Verificar se a calculadora está funcionando
document.addEventListener('DOMContentLoaded', function() {
    console.log('Página de preços carregada, calculadora pronta!');
    
    // Aplicar formatação inteligente de armazenamento
    aplicarFormatacaoArmazenamento();
    
    // Carregar preços dos planos dinamicamente
    loadPlanPrices();
    
    // Restaurar valores salvos da calculadora
    restaurarValoresCalculadora();
    
    // Adicionar event listeners para salvar valores automaticamente
    adicionarEventListenersCalculadora();
    
    // Atualizar preços a cada 30 segundos
    setInterval(loadPlanPrices, 30000);
});

// Função para salvar valores da calculadora no localStorage
function salvarValoresCalculadora() {
    const valores = {
        projects: document.getElementById('projects').value,
        layers: document.getElementById('layers').value,
        public_maps: document.getElementById('public_maps').value,
        page_views: document.getElementById('page_views').value,
        employees: document.getElementById('employees').value,
        server_usage: document.getElementById('server_usage').value
    };
    
    localStorage.setItem('calculadora_webgis', JSON.stringify(valores));
    console.log('Valores da calculadora salvos:', valores);
}

// Função para restaurar valores da calculadora do localStorage
function restaurarValoresCalculadora() {
    const valoresSalvos = localStorage.getItem('calculadora_webgis');
    
    if (valoresSalvos) {
        try {
            const valores = JSON.parse(valoresSalvos);
            
            if (valores.projects) document.getElementById('projects').value = valores.projects;
            if (valores.layers) document.getElementById('layers').value = valores.layers;
            if (valores.public_maps) document.getElementById('public_maps').value = valores.public_maps;
            if (valores.page_views) document.getElementById('page_views').value = valores.page_views;
            if (valores.employees) document.getElementById('employees').value = valores.employees;
            if (valores.server_usage) document.getElementById('server_usage').value = valores.server_usage;
            
            console.log('Valores da calculadora restaurados:', valores);
        } catch (error) {
            console.error('Erro ao restaurar valores da calculadora:', error);
        }
    }
}

// Função para aplicar formatação inteligente de armazenamento
function aplicarFormatacaoArmazenamento() {
    // Valores em GB para cada plano
    const starterStorage = 50;
    const professionalStorage = 500;
    const enterpriseStorage = 1000;
    
    // Aplicar formatação inteligente com verificações de segurança
    const starterElement = document.getElementById('starter-storage');
    const professionalElement = document.getElementById('professional-storage');
    const enterpriseElement = document.getElementById('enterprise-storage');
    
    if (starterElement) {
        starterElement.textContent = formatarArmazenamentoInteligente(starterStorage);
    }
    
    if (professionalElement) {
        professionalElement.textContent = formatarArmazenamentoInteligente(professionalStorage);
    }
    
    if (enterpriseElement) {
        enterpriseElement.textContent = formatarArmazenamentoInteligente(enterpriseStorage);
    }
}

async function loadPlanPrices() {
    try {
        const response = await fetch('/api/pricing/plans');
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        if (data.success) {
            updatePlanPrices(data.plans);
        } else {
            console.error('Erro ao carregar preços:', data.error);
        }
    } catch (error) {
        console.error('Erro ao carregar preços dos planos:', error);
    }
}

function updatePlanPrices(plans) {
    // Atualizar preços dos planos
    if (plans.starter) {
        const starterPriceElement = document.getElementById('starter-price');
        const starterOriginalElement = document.getElementById('starter-original-price');
        const starterDiscountElement = document.getElementById('starter-discount');
        
        if (starterPriceElement) {
            starterPriceElement.textContent = formatarMoeda(plans.starter.final_price);
        }
        
        if (starterOriginalElement) {
            const spanElement = starterOriginalElement.querySelector('span');
            if (spanElement) {
                spanElement.textContent = formatarMoeda(plans.starter.original_price);
                starterOriginalElement.style.display = 'block';
            }
        }
        
        if (plans.starter.discount > 0 && starterDiscountElement) {
            const spanElement = starterDiscountElement.querySelector('span');
            if (spanElement) {
                spanElement.textContent = `${formatarPercentual(plans.starter.discount, true, 1)} de desconto`;
                starterDiscountElement.style.display = 'block';
            }
        }
    }
    
    if (plans.professional) {
        const professionalPriceElement = document.getElementById('professional-price');
        const professionalOriginalElement = document.getElementById('professional-original-price');
        const professionalDiscountElement = document.getElementById('professional-discount');
        
        if (professionalPriceElement) {
            professionalPriceElement.textContent = formatarMoeda(plans.professional.final_price);
        }
        
        if (professionalOriginalElement) {
            const spanElement = professionalOriginalElement.querySelector('span');
            if (spanElement) {
                spanElement.textContent = formatarMoeda(plans.professional.original_price);
                professionalOriginalElement.style.display = 'block';
            }
        }
        
        if (plans.professional.discount > 0 && professionalDiscountElement) {
            const spanElement = professionalDiscountElement.querySelector('span');
            if (spanElement) {
                spanElement.textContent = `${formatarPercentual(plans.professional.discount, true, 1)} de desconto`;
                professionalDiscountElement.style.display = 'block';
            }
        }
    }
    
    if (plans.enterprise) {
        const enterprisePriceElement = document.getElementById('enterprise-price');
        const enterpriseOriginalElement = document.getElementById('enterprise-original-price');
        const enterpriseDiscountElement = document.getElementById('enterprise-discount');
        
        if (enterprisePriceElement) {
            enterprisePriceElement.textContent = formatarMoeda(plans.enterprise.final_price);
        }
        
        if (enterpriseOriginalElement) {
            const spanElement = enterpriseOriginalElement.querySelector('span');
            if (spanElement) {
                spanElement.textContent = formatarMoeda(plans.enterprise.original_price);
                enterpriseOriginalElement.style.display = 'block';
            }
        }
        
        if (plans.enterprise.discount > 0 && enterpriseDiscountElement) {
            const spanElement = enterpriseDiscountElement.querySelector('span');
            if (spanElement) {
                spanElement.textContent = `${formatarPercentual(plans.enterprise.discount, true, 1)} de desconto`;
                enterpriseDiscountElement.style.display = 'block';
            }
        }
    }

    // Atualizar preços do plano Personalizado
    const customPriceElement = document.getElementById('custom-price');
    const customOriginalElement = document.getElementById('custom-original-price');
    const customDiscountElement = document.getElementById('custom-discount');

    if (customPriceElement) {
        customPriceElement.textContent = formatarMoeda(result.total_cost); // Usar o preço calculado pela API
    }

    if (customOriginalElement) {
        const spanElement = customOriginalElement.querySelector('span');
        if (spanElement) {
            spanElement.textContent = formatarMoeda(result.total_cost); // Usar o preço calculado pela API
            customOriginalElement.style.display = 'block';
        }
    }

    if (customDiscountElement) {
        const spanElement = customDiscountElement.querySelector('span');
        if (spanElement) {
            spanElement.textContent = `${formatarPercentual(result.total_discount, true, 1)} de desconto`; // Usar o desconto calculado pela API
            customDiscountElement.style.display = 'block';
        }
    }
}

// Função para rolar a página até a calculadora
function scrollToCalculator() {
    const calculatorSection = document.querySelector('.calculator-section');
    if (calculatorSection) {
        calculatorSection.scrollIntoView({ behavior: 'smooth' });
    }
}
</script>
{% endblock %}
