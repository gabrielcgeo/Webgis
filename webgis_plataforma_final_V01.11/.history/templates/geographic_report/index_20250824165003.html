{% extends 'layout.html' %}
{% block title %}Relat√≥rio Geogr√°fico - {{ company.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header do Relat√≥rio Geogr√°fico -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-1">
                        <i class="fas fa-map-marked-alt text-primary me-2"></i>
                        Relat√≥rio Geogr√°fico
                    </h1>
                    <p class="text-muted mb-0">Transforme dados geogr√°ficos em narrativas visuais interativas</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-lg" onclick="createNewReport()">
                        <i class="fas fa-plus me-2"></i>
                        Criar Novo Relat√≥rio
                    </button>
                    <a href="{{ url_for('geographic_report_templates') }}" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-layer-group me-2"></i>
                        Templates
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Estat√≠sticas R√°pidas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-1" id="total-reports">0</h4>
                            <p class="mb-0">Total de Relat√≥rios</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-file-alt fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-1" id="published-reports">0</h4>
                            <p class="mb-0">Publicados</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-globe fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-1" id="draft-reports">0</h4>
                            <p class="mb-0">Rascunhos</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-edit fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-1" id="total-views">0</h4>
                            <p class="mb-0">Visualiza√ß√µes</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-eye fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros e Busca -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="search-reports" placeholder="Buscar relat√≥rios...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="status-filter">
                                <option value="">Todos os Status</option>
                                <option value="draft">Rascunhos</option>
                                <option value="published">Publicados</option>
                                <option value="archived">Arquivados</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="sort-reports">
                                <option value="updated_at">Mais Recentes</option>
                                <option value="title">T√≠tulo A-Z</option>
                                <option value="views">Mais Visualizados</option>
                                <option value="created_at">Data de Cria√ß√£o</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-primary w-100" onclick="applyFilters()">
                                <i class="fas fa-filter me-2"></i>Filtrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Relat√≥rios -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Meus Relat√≥rios</h5>
                </div>
                <div class="card-body">
                    <div id="reports-container">
                        <!-- Relat√≥rios ser√£o carregados aqui dinamicamente -->
                        <div class="text-center py-5">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                            <p class="text-muted">Carregando relat√≥rios...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Cria√ß√£o R√°pida -->
<div class="modal fade" id="quickCreateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Criar Novo Relat√≥rio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quick-create-form">
                    <div class="mb-3">
                        <label class="form-label">T√≠tulo do Relat√≥rio</label>
                        <input type="text" class="form-control" id="quick-title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descri√ß√£o</label>
                        <textarea class="form-control" id="quick-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Template Base</label>
                        <select class="form-select" id="quick-template">
                            <option value="">Sem template (come√ßar do zero)</option>
                            <optgroup label="üìä An√°lises e Relat√≥rios">
                                <option value="corporate-report">Relat√≥rio Corporativo Profissional</option>
                                <option value="market-analysis">An√°lise de Mercado</option>
                                <option value="data-analysis">An√°lise de Dados</option>
                                <option value="location-analysis">An√°lise de Localiza√ß√£o</option>
                            </optgroup>
                            <optgroup label="üìö Educacional e Hist√≥rico">
                                <option value="historical-timeline">Linha do Tempo Hist√≥rica</option>
                                <option value="educational-guide">Guia Educacional</option>
                            </optgroup>
                            <optgroup label="üó∫Ô∏è Turismo e Viagem">
                                <option value="tourism-interactive">Turismo Interativo</option>
                                <option value="travel-route">Roteiro de Viagem</option>
                            </optgroup>
                            <optgroup label="üè¢ Projetos e Portf√≥lios">
                                <option value="project-portfolio">Portf√≥lio de Projetos</option>
                                <option value="events-map">Mapa de Eventos</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descri√ß√£o do Template</label>
                        <div id="template-description" class="form-text text-muted">
                            Selecione um template para ver sua descri√ß√£o
                        </div>
                    </div>
                    <div class="mb-3" id="template-preview-container" style="display: none;">
                        <label class="form-label">Pr√©via do Template</label>
                        <div id="template-preview" class="border rounded p-3 bg-light">
                            <!-- Pr√©via ser√° carregada aqui -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="clearQuickCreateForm()">
                    <i class="fas fa-eraser me-2"></i>Limpar
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitQuickCreate()">
                    <i class="fas fa-rocket me-2"></i>Criar e Come√ßar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Templates -->
<div class="modal fade" id="templatesModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Templates de Relat√≥rio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4" id="templates-grid">
                    <!-- Templates ser√£o carregados aqui -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/geographic_report.js') }}"></script>
<script>
// Inicializa√ß√£o da p√°gina
document.addEventListener('DOMContentLoaded', function() {
    loadReports();
    loadStatistics();
    setupEventListeners();
});

function setupEventListeners() {
    // Busca em tempo real
    document.getElementById('search-reports').addEventListener('input', debounce(function() {
        applyFilters();
    }, 300));
    
    // Filtros
    document.getElementById('status-filter').addEventListener('change', applyFilters);
    document.getElementById('sort-reports').addEventListener('change', applyFilters);
    
    // Template selection change
    document.getElementById('quick-template').addEventListener('change', updateTemplateDescription);
}

function createNewReport() {
    const modal = new bootstrap.Modal(document.getElementById('quickCreateModal'));
    modal.show();
}

function showTemplates() {
    loadTemplates();
    const modal = new bootstrap.Modal(document.getElementById('templatesModal'));
    modal.show();
}

function submitQuickCreate() {
    const title = document.getElementById('quick-title').value;
    const description = document.getElementById('quick-description').value;
    const template = document.getElementById('quick-template').value;
    
    if (!title.trim()) {
        alert('Por favor, insira um t√≠tulo para o relat√≥rio.');
        return;
    }
    
    // Configura√ß√£o base do relat√≥rio
    let config = {
        template: template,
        stops: [],
        layers: [],
        design: {
            theme: 'default',
            layout: 'classic',
            colors: {
                primary: '#007bff',
                secondary: '#6c757d',
                background: '#ffffff',
                text: '#212529'
            }
        }
    };
    
    // Configura√ß√µes espec√≠ficas para cada template
    if (template === 'corporate-report') {
        config.design.layout = 'professional';
        config.design.theme = 'corporate';
        config.design.colors = {
            primary: '#2c3e50',
            secondary: '#2980b9',
            background: '#fcfcfc',
            text: '#34495e'
        };
        config.structure = 'hierarchical';
        config.navigation = 'sidebar';
    } else if (template === 'market-analysis') {
        config.design.layout = 'classic';
        config.design.theme = 'business';
        config.design.colors = {
            primary: '#4A90E2',
            secondary: '#27AE60',
            background: '#ffffff',
            text: '#2c3e50'
        };
    } else if (template === 'historical-timeline') {
        config.design.layout = 'timeline';
        config.design.theme = 'historical';
        config.design.colors = {
            primary: '#8E44AD',
            secondary: '#E67E22',
            background: '#f8f9fa',
            text: '#2c3e50'
        };
    }
    
    // Criar relat√≥rio via API
    fetch('/api/geographic-report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: title,
            description: description,
            config: config
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fechar modal e redirecionar para edi√ß√£o
            bootstrap.Modal.getInstance(document.getElementById('quickCreateModal')).hide();
            window.location.href = `/geographic-report/edit/${data.report_id}`;
        } else {
            alert('Erro ao criar relat√≥rio: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao criar relat√≥rio. Tente novamente.');
    });
}

function updateTemplateDescription() {
    const templateSelect = document.getElementById('quick-template');
    const descriptionDiv = document.getElementById('template-description');
    const previewContainer = document.getElementById('template-preview-container');
    const previewDiv = document.getElementById('template-preview');
    const selectedTemplate = templateSelect.value;
    
    const templateDescriptions = {
        'corporate-report': 'Template corporativo com estrutura hier√°rquica, navega√ß√£o lateral e design profissional para relat√≥rios empresariais. Inclui cap√≠tulos, subcap√≠tulos e navega√ß√£o lateral.',
        'market-analysis': 'Template ideal para an√°lises de mercado com foco em narrativa e dados geogr√°ficos. Perfeito para apresenta√ß√µes empresariais.',
        'historical-timeline': 'Narrativa cronol√≥gica com eventos hist√≥ricos e localiza√ß√µes geogr√°ficas. Ideal para projetos educacionais e hist√≥ricos.',
        'tourism-interactive': 'Mapa imersivo com pontos tur√≠sticos, fotos e informa√ß√µes detalhadas. Perfeito para guias tur√≠sticos.',
        'location-analysis': 'Equil√≠brio perfeito entre mapa e conte√∫do para an√°lises de localiza√ß√£o. Ideal para estudos de viabilidade.',
        'project-portfolio': 'Apresenta√ß√£o visual de projetos em formato de grid com mapa interativo. Perfeito para portf√≥lios empresariais.',
        'educational-guide': 'Template educativo com foco na narrativa e aprendizado geogr√°fico. Ideal para materiais educacionais.',
        'data-analysis': 'Template avan√ßado para an√°lise de dados com visualiza√ß√µes interativas. Perfeito para relat√≥rios t√©cnicos.',
        'travel-route': 'Roteiro interativo com mapa imersivo e pontos de interesse. Ideal para planejamento de viagens.',
        'events-map': 'Template equilibrado para mapeamento de eventos e atividades. Perfeito para calend√°rios de eventos.'
    };
    
    const templateColors = {
        'corporate-report': '#34495E',
        'market-analysis': '#4A90E2',
        'historical-timeline': '#8E44AD',
        'tourism-interactive': '#27AE60',
        'location-analysis': '#F39C12',
        'project-portfolio': '#E74C3C',
        'educational-guide': '#3498DB',
        'data-analysis': '#9B59B6',
        'travel-route': '#1ABC9C',
        'events-map': '#E67E22'
    };
    
    if (selectedTemplate && templateDescriptions[selectedTemplate]) {
        descriptionDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>${templateSelect.options[templateSelect.selectedIndex].text}</strong><br>
                ${templateDescriptions[selectedTemplate]}
            </div>
        `;
        
        // Mostrar pr√©via do template
        previewContainer.style.display = 'block';
        previewDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <div style="width: 60px; height: 60px; background: ${templateColors[selectedTemplate]}; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-layer-group text-white fa-lg"></i>
                    </div>
                </div>
                <div class="flex-grow-1">
                    <h6 class="mb-1">${templateSelect.options[templateSelect.selectedIndex].text}</h6>
                    <div class="d-flex gap-1">
                        <span class="badge bg-primary">Mapa</span>
                        <span class="badge bg-success">Conte√∫do</span>
                        <span class="badge bg-info">Interativo</span>
                    </div>
                </div>
                <div class="text-end">
                    <small class="text-muted d-block">Layout</small>
                    <span class="badge bg-secondary">${getTemplateLayout(selectedTemplate)}</span>
                </div>
            </div>
        `;
    } else {
        descriptionDiv.innerHTML = '<span class="text-muted">Selecione um template para ver sua descri√ß√£o</span>';
        previewContainer.style.display = 'none';
    }
}

function getTemplateLayout(templateId) {
    const layouts = {
        'corporate-report': 'Profissional',
        'market-analysis': 'Cl√°ssico',
        'historical-timeline': 'Timeline',
        'tourism-interactive': 'Imersivo',
        'location-analysis': 'Cl√°ssico',
        'project-portfolio': 'Grid',
        'educational-guide': 'Cl√°ssico',
        'data-analysis': 'Centralizado',
        'travel-route': 'Imersivo',
        'events-map': 'Grid'
    };
    return layouts[templateId] || 'Padr√£o';
}

function loadReports() {
    // Implementar carregamento de relat√≥rios
    console.log('Carregando relat√≥rios...');
}

function loadStatistics() {
    // Implementar carregamento de estat√≠sticas
    console.log('Carregando estat√≠sticas...');
}

function loadTemplates() {
    // Implementar carregamento de templates
    console.log('Carregando templates...');
}

function applyFilters() {
    // Implementar aplica√ß√£o de filtros
    console.log('Aplicando filtros...');
}

// Fun√ß√£o utilit√°ria para debounce
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
{% endblock %}
