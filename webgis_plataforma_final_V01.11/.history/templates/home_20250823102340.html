{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Se√ß√£o de Boas-vindas -->
    <div class="col-lg-4 mb-4">
      <div class="text-center py-5">
        <h1 class="text-primary">Bem-vindo ao WebGIS</h1>
        <p class="lead">Plataforma completa de geoprocessamento e an√°lise espacial.</p>
        <div class="d-flex gap-2 justify-content-center mb-4">
          <a class="btn btn-primary btn-lg" href="{{ url_for('login') }}">
            <i class="fas fa-sign-in-alt me-2"></i>Entrar
          </a>
        </div>
        
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">üåê Portal da Empresa</h5>
            <p class="card-text">Se voc√™ sabe a URL do portal da sua empresa, acesse diretamente:</p>
            <code>/portal/&lt;slug&gt;</code>
            <small class="d-block text-muted mt-2">Ex.: {{ request.host_url }}portal/minha-empresa</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Calculadora de Pre√ßos -->
    <div class="col-lg-8">
      <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
          <h3 class="mb-0">
            <i class="fas fa-calculator me-2"></i>Calculadora de Pre√ßos WebGIS
          </h3>
          <small>Descubra o custo ideal para sua demanda de geoprocessamento</small>
        </div>
        <div class="card-body">
          <form id="pricingForm">
            <div class="row">
              <!-- Coluna 1 -->
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="projects" class="form-label">
                    <i class="fas fa-project-diagram text-primary me-2"></i>N√∫mero de Projetos
                  </label>
                  <input type="number" class="form-control" id="projects" min="0" value="5">
                  <small class="form-text text-muted">Projetos para organizar suas camadas</small>
                </div>

                <div class="mb-3">
                  <label for="layers" class="form-label">
                    <i class="fas fa-layer-group text-success me-2"></i>N√∫mero de Camadas
                  </label>
                  <input type="number" class="form-control" id="layers" min="0" value="100">
                  <small class="form-text text-muted">Shapefiles, GeoTIFFs, KMLs, etc.</small>
                </div>

                <div class="mb-3">
                  <label for="public_maps" class="form-label">
                    <i class="fas fa-globe-americas text-info me-2"></i>Mapas P√∫blicos
                  </label>
                  <input type="number" class="form-control" id="public_maps" min="0" value="10">
                  <small class="form-text text-muted">Mapas compartilhados publicamente</small>
                </div>
              </div>

              <!-- Coluna 2 -->
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="page_views" class="form-label">
                    <i class="fas fa-eye text-warning me-2"></i>Visualiza√ß√µes/M√™s
                  </label>
                  <input type="number" class="form-control" id="page_views" min="0" value="50000">
                  <small class="form-text text-muted">Acessos aos mapas p√∫blicos</small>
                </div>

                <div class="mb-3">
                  <label for="employees" class="form-label">
                    <i class="fas fa-users text-secondary me-2"></i>Funcion√°rios Cadastrados
                  </label>
                  <input type="number" class="form-control" id="employees" min="0" value="15">
                  <small class="form-text text-muted">Usu√°rios com acesso √† plataforma</small>
                </div>

                <div class="mb-3">
                  <label for="server_usage" class="form-label">
                    <i class="fas fa-server text-danger me-2"></i>Uso do Servidor (GB)
                  </label>
                  <input type="number" class="form-control" id="server_usage" min="0" step="0.1" value="50">
                  <small class="form-text text-muted">Armazenamento + transfer√™ncia de dados</small>
                </div>
              </div>
            </div>

            <div class="row mt-4">
              <div class="col-12 text-center">
                <button type="button" class="btn btn-primary btn-lg" onclick="calculatePrice()">
                  <i class="fas fa-calculator me-2"></i>Calcular Pre√ßo
                </button>
                <button type="button" class="btn btn-outline-secondary ms-2" onclick="resetForm()">
                  <i class="fas fa-redo me-2"></i>Limpar
                </button>
              </div>
            </div>
          </form>

          <!-- Resultado -->
          <div id="pricing-result" class="mt-4" style="display: none;">
            <div class="alert alert-success">
              <div class="row">
                <div class="col-md-6">
                  <h4 class="alert-heading">
                    <i class="fas fa-money-bill-wave me-2"></i>Pre√ßo Total Mensal
                  </h4>
                  <h2 class="text-success mb-0" id="total-price">R$ 0,00</h2>
                  <div class="mt-3">
                    <div class="d-flex justify-content-between">
                      <span>Anual:</span>
                      <strong id="annual-price">R$ 0,00</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                      <span>Margem estimada:</span>
                      <strong class="text-success" id="profit-margin">0%</strong>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div id="price-breakdown"></div>
                </div>
              </div>
            </div>
            
            <!-- An√°lise Avan√ßada -->
            <div class="row mt-4">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h6 class="mb-0">
                      <i class="fas fa-chart-pie me-2"></i>Distribui√ß√£o de Custos
                    </h6>
                  </div>
                  <div class="card-body">
                    <canvas id="costChart" width="200" height="200"></canvas>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h6 class="mb-0">
                      <i class="fas fa-lightbulb me-2"></i>Recomenda√ß√µes
                    </h6>
                  </div>
                  <div class="card-body">
                    <div id="recommendations"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Compara√ß√£o de Planos -->
            <div class="mt-4">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">
                    <i class="fas fa-balance-scale me-2"></i>Compara√ß√£o de Planos
                  </h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-4">
                      <div class="card border-primary">
                        <div class="card-header bg-primary text-white text-center">
                          <h6 class="mb-0">Starter</h6>
                        </div>
                        <div class="card-body text-center">
                          <h4 class="text-primary" id="starter-price">R$ 0,00</h4>
                          <small class="text-muted">Ideal para pequenas empresas</small>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="card border-success">
                        <div class="card-header bg-success text-white text-center">
                          <h6 class="mb-0">Professional</h6>
                        </div>
                        <div class="card-body text-center">
                          <h4 class="text-success" id="professional-price">R$ 0,00</h4>
                          <small class="text-muted">Para empresas em crescimento</small>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="card border-warning">
                        <div class="card-header bg-warning text-white text-center">
                          <h6 class="mb-0">Enterprise</h6>
                        </div>
                        <div class="card-body text-center">
                          <h4 class="text-warning" id="enterprise-price">R$ 0,00</h4>
                          <small class="text-muted">Para grandes organiza√ß√µes</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Simulador de Cen√°rios -->
            <div class="mt-4">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">
                    <i class="fas fa-rocket me-2"></i>Simulador de Cen√°rios
                  </h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-3">
                      <label class="form-label">Crescimento de Projetos</label>
                      <select class="form-control" id="growth-scenario">
                        <option value="0">Sem crescimento</option>
                        <option value="0.1">10% ao m√™s</option>
                        <option value="0.2">20% ao m√™s</option>
                        <option value="0.5">50% ao m√™s</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Per√≠odo (meses)</label>
                      <input type="number" class="form-control" id="growth-period" value="12" min="1" max="60">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Custo Operacional</label>
                      <input type="number" class="form-control" id="operational-cost" value="500" min="0">
                    </div>
                    <div class="col-md-3">
                      <button class="btn btn-primary mt-4" onclick="simulateGrowth()">
                        <i class="fas fa-play me-2"></i>Simular
                      </button>
                    </div>
                  </div>
                  <div id="growth-results" class="mt-3"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Loading -->
          <div id="pricing-loading" class="text-center mt-4" style="display: none;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Calculando...</span>
            </div>
            <p class="mt-2">Calculando seu or√ßamento personalizado...</p>
          </div>
        </div>

        <div class="card-footer bg-light">
          <div class="row text-center">
            <div class="col-md-4">
              <i class="fas fa-shield-alt text-success fa-2x mb-2"></i>
              <h6>Seguro e Confi√°vel</h6>
              <small class="text-muted">Dados protegidos e backups autom√°ticos</small>
            </div>
            <div class="col-md-4">
              <i class="fas fa-rocket text-primary fa-2x mb-2"></i>
              <h6>Alta Performance</h6>
              <small class="text-muted">Processamento r√°pido de dados GIS</small>
            </div>
            <div class="col-md-4">
              <i class="fas fa-headset text-info fa-2x mb-2"></i>
              <h6>Suporte 24/7</h6>
              <small class="text-muted">Assist√™ncia t√©cnica especializada</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.card {
  border: none;
  border-radius: 15px;
}

.card-header {
  border-radius: 15px 15px 0 0 !important;
}

.form-control:focus {
  border-color: #00d28f;
  box-shadow: 0 0 0 0.2rem rgba(0, 210, 143, 0.25);
}

.btn-primary {
  background-color: #00d28f;
  border-color: #00d28f;
}

.btn-primary:hover {
  background-color: #00b377;
  border-color: #00b377;
}

.text-primary {
  color: #00d28f !important;
}

#price-breakdown {
  font-size: 0.9em;
}

.breakdown-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 5px;
  padding: 3px 8px;
  background-color: rgba(0, 210, 143, 0.1);
  border-radius: 5px;
}

.alert-success {
  border-color: #00d28f;
  background-color: rgba(0, 210, 143, 0.1);
  color: #00805a;
}
</style>

<script>
async function calculatePrice() {
    const form = document.getElementById('pricingForm');
    const resultDiv = document.getElementById('pricing-result');
    const loadingDiv = document.getElementById('pricing-loading');
    
    // Mostrar loading
    loadingDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    
    const data = {
        projects: parseInt(document.getElementById('projects').value) || 0,
        layers: parseInt(document.getElementById('layers').value) || 0,
        public_maps: parseInt(document.getElementById('public_maps').value) || 0,
        page_views: parseInt(document.getElementById('page_views').value) || 0,
        employees: parseInt(document.getElementById('employees').value) || 0,
        server_usage: parseFloat(document.getElementById('server_usage').value) || 0
    };
    
    try {
        const response = await fetch('/api/pricing/calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            throw new Error('Erro ao calcular pre√ßos');
        }
        
        const result = await response.json();
        displayResult(result);
        
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao calcular pre√ßos. Tente novamente.');
    } finally {
        loadingDiv.style.display = 'none';
    }
}

function displayResult(result) {
    const totalPriceElement = document.getElementById('total-price');
    const breakdownElement = document.getElementById('price-breakdown');
    const resultDiv = document.getElementById('pricing-result');
    
    // Formatar pre√ßo total
    totalPriceElement.textContent = `R$ ${result.total_cost.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    
    // Atualizar pre√ßos anuais e margens
    const annualPrice = result.total_cost * 12;
    document.getElementById('annual-price').textContent = `R$ ${annualPrice.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    
    // Calcular margem estimada (assumindo 70% de margem)
    const estimatedProfit = result.total_cost * 0.7;
    const profitMargin = ((estimatedProfit / result.total_cost) * 100).toFixed(1);
    document.getElementById('profit-margin').textContent = `${profitMargin}%`;
    
    // Criar breakdown
    let breakdownHTML = '<h6>Detalhamento dos Custos:</h6>';
    
    const labels = {
        'projects': 'Projetos',
        'layers': 'Camadas', 
        'public_maps': 'Mapas P√∫blicos',
        'page_views': 'Visualiza√ß√µes',
        'employees': 'Funcion√°rios',
        'server_usage': 'Servidor'
    };
    
    for (const [key, item] of Object.entries(result.breakdown)) {
        if (item.weighted_cost > 0) {
            breakdownHTML += `
                <div class="breakdown-item">
                    <span>${labels[key]}:</span>
                    <span>R$ ${item.weighted_cost.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                </div>
            `;
        }
    }
    
    breakdownElement.innerHTML = breakdownHTML;
    
    // Atualizar compara√ß√£o de planos
    updatePlanComparison(result.total_cost);
    
    // Gerar recomenda√ß√µes
    generateRecommendations(result);
    
    // Criar gr√°fico de distribui√ß√£o de custos
    createCostChart(result.breakdown);
    
    resultDiv.style.display = 'block';
}

function updatePlanComparison(totalCost) {
    // Calcular pre√ßos dos planos baseado no custo total
    const starterPrice = Math.max(totalCost * 0.8, 99.90);
    const professionalPrice = totalCost * 1.1;
    const enterprisePrice = totalCost * 1.3;
    
    document.getElementById('starter-price').textContent = `R$ ${starterPrice.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    document.getElementById('professional-price').textContent = `R$ ${professionalPrice.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    document.getElementById('enterprise-price').textContent = `R$ ${enterprisePrice.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
}

function generateRecommendations(result) {
    const recommendationsDiv = document.getElementById('recommendations');
    let recommendations = [];
    
    // Analisar breakdown e gerar recomenda√ß√µes
    if (result.breakdown.projects && result.breakdown.projects.weighted_cost > result.total_cost * 0.4) {
        recommendations.push('üí° Considere consolidar projetos para reduzir custos');
    }
    
    if (result.breakdown.layers && result.breakdown.layers.weighted_cost > result.total_cost * 0.3) {
        recommendations.push('üó∫Ô∏è Otimize suas camadas para melhor performance');
    }
    
    if (result.breakdown.page_views && result.breakdown.page_views.weighted_cost < result.total_cost * 0.1) {
        recommendations.push('üìä Visualiza√ß√µes com boa rela√ß√£o custo-benef√≠cio');
    }
    
    if (result.breakdown.server_usage && result.breakdown.server_usage.weighted_cost > result.total_cost * 0.2) {
        recommendations.push('üñ•Ô∏è Considere otimizar o uso do servidor');
    }
    
    if (recommendations.length === 0) {
        recommendations.push('‚úÖ Sua configura√ß√£o est√° bem balanceada!');
    }
    
    recommendationsDiv.innerHTML = recommendations.map(rec => `<div class="mb-2">${rec}</div>`).join('');
}

function createCostChart(breakdown) {
    const ctx = document.getElementById('costChart').getContext('2d');
    
    // Destruir gr√°fico anterior se existir
    if (window.costChart) {
        window.costChart.destroy();
    }
    
    const labels = {
        'projects': 'Projetos',
        'layers': 'Camadas', 
        'public_maps': 'Mapas P√∫blicos',
        'page_views': 'Visualiza√ß√µes',
        'employees': 'Funcion√°rios',
        'server_usage': 'Servidor'
    };
    
    const data = [];
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    
    let colorIndex = 0;
    for (const [key, item] of Object.entries(breakdown)) {
        if (item.weighted_cost > 0) {
            data.push({
                label: labels[key],
                value: item.weighted_cost,
                color: colors[colorIndex % colors.length]
            });
            colorIndex++;
        }
    }
    
    window.costChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(item => item.label),
            datasets: [{
                data: data.map(item => item.value),
                backgroundColor: data.map(item => item.color),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });
}

function simulateGrowth() {
    const growthRate = parseFloat(document.getElementById('growth-scenario').value);
    const period = parseInt(document.getElementById('growth-period').value);
    const operationalCost = parseFloat(document.getElementById('operational-cost').value);
    
    let currentProjects = parseInt(document.getElementById('projects').value) || 5;
    let totalRevenue = 0;
    let totalCost = 0;
    
    let resultsHTML = '<h6>Proje√ß√£o de Crescimento:</h6>';
    resultsHTML += '<div class="table-responsive"><table class="table table-sm">';
    resultsHTML += '<thead><tr><th>M√™s</th><th>Projetos</th><th>Receita</th><th>Custo</th><th>Lucro</th></tr></thead><tbody>';
    
    for (let month = 1; month <= period; month++) {
        const monthlyRevenue = currentProjects * 25; // R$ 25 por projeto
        const monthlyCost = operationalCost;
        const monthlyProfit = monthlyRevenue - monthlyCost;
        
        totalRevenue += monthlyRevenue;
        totalCost += monthlyCost;
        
        resultsHTML += `<tr>
            <td>${month}</td>
            <td>${currentProjects}</td>
            <td>R$ ${monthlyRevenue.toLocaleString('pt-BR')}</td>
            <td>R$ ${monthlyCost.toLocaleString('pt-BR')}</td>
            <td class="${monthlyProfit >= 0 ? 'text-success' : 'text-danger'}">R$ ${monthlyProfit.toLocaleString('pt-BR')}</td>
        </tr>`;
        
        // Aplicar crescimento
        currentProjects = Math.floor(currentProjects * (1 + growthRate));
    }
    
    const totalProfit = totalRevenue - totalCost;
    const roi = ((totalProfit / totalCost) * 100).toFixed(1);
    
    resultsHTML += '</tbody></table></div>';
    resultsHTML += `<div class="alert alert-info mt-3">
        <strong>Resumo:</strong><br>
        Receita Total: R$ ${totalRevenue.toLocaleString('pt-BR')}<br>
        Custo Total: R$ ${totalCost.toLocaleString('pt-BR')}<br>
        Lucro Total: R$ ${totalProfit.toLocaleString('pt-BR')}<br>
        ROI: ${roi}%
    </div>`;
    
    document.getElementById('growth-results').innerHTML = resultsHTML;
}

function resetForm() {
    document.getElementById('projects').value = 5;
    document.getElementById('layers').value = 100;
    document.getElementById('public_maps').value = 10;
    document.getElementById('page_views').value = 50000;
    document.getElementById('employees').value = 15;
    document.getElementById('server_usage').value = 50;
    
    document.getElementById('pricing-result').style.display = 'none';
}

// Calcular automaticamente quando os valores mudarem
document.querySelectorAll('#pricingForm input').forEach(input => {
    input.addEventListener('input', debounce(calculatePrice, 1000));
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Calcular pre√ßo inicial ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', calculatePrice);
</script>
{% endblock %}

