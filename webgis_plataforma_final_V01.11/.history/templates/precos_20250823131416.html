{% extends 'layout.html' %}

{% block content %}
<style>
/* Estilos para a p√°gina de pre√ßos */
.pricing-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    border-radius: 15px;
}

.pricing-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.pricing-card.featured {
    border: 3px solid #0d6efd;
    transform: scale(1.05);
}

.pricing-card.featured:hover {
    transform: scale(1.05) translateY(-5px);
}

.plan-price {
    font-size: 3rem;
    font-weight: bold;
    color: #0d6efd;
}

.plan-features {
    list-style: none;
    padding: 0;
}

.plan-features li {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.plan-features li:before {
    content: "‚úì";
    color: #28a745;
    font-weight: bold;
    margin-right: 10px;
}

.calculator-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 3rem;
}

.breakdown-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
}

.breakdown-item:hover {
    background-color: #f8f9fa;
}

.result-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}

.feature-icon {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: #0d6efd;
}
</style>

<div class="container-fluid">
    <!-- Header da P√°gina -->
    <div class="text-center py-5 mb-5">
        <h1 class="display-4 text-primary mb-3">
            <i class="fas fa-tags me-3"></i>Pre√ßos e Planos WebGIS
        </h1>
        <p class="lead text-muted">Escolha o plano ideal para sua empresa ou calcule um pre√ßo personalizado</p>
    </div>

    <!-- Se√ß√£o de Planos -->
    <div class="row mb-5">
        <div class="col-12">
            <h2 class="text-center mb-4">
                <i class="fas fa-rocket me-2"></i>Planos Dispon√≠veis
            </h2>
        </div>
        
        <!-- Plano Starter -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card pricing-card h-100">
                <div class="card-header text-center bg-light">
                    <h4 class="mb-0">
                        <i class="fas fa-seedling text-success me-2"></i>Starter
                    </h4>
                    <p class="text-muted mb-0">Ideal para pequenas empresas</p>
                </div>
                <div class="card-body text-center">
                    <div class="plan-price mb-3">R$ 199</div>
                    <p class="text-muted">por m√™s</p>
                    <ul class="plan-features text-start">
                        <li>At√© 5 projetos</li>
                        <li>At√© 50 camadas</li>
                        <li>At√© 3 mapas p√∫blicos</li>
                        <li>At√© 10.000 visualiza√ß√µes/m√™s</li>
                        <li>At√© 5 funcion√°rios</li>
                        <li>At√© 25 GB de armazenamento</li>
                        <li>Suporte por email</li>
                        <li>1 vCPU + 2 GB RAM</li>
                    </ul>
                </div>
                <div class="card-footer text-center">
                    <a href="{{ url_for('login') }}" class="btn btn-outline-primary btn-lg w-100">
                        <i class="fas fa-rocket me-2"></i>Come√ßar Agora
                    </a>
                </div>
            </div>
        </div>

        <!-- Plano Professional (Featured) -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card pricing-card featured h-100">
                <div class="card-header text-center bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-star text-warning me-2"></i>Professional
                    </h4>
                    <p class="mb-0">Mais popular</p>
                </div>
                <div class="card-body text-center">
                    <div class="plan-price mb-3">R$ 499</div>
                    <p class="text-muted">por m√™s</p>
                    <ul class="plan-features text-start">
                        <li>At√© 20 projetos</li>
                        <li>At√© 200 camadas</li>
                        <li>At√© 15 mapas p√∫blicos</li>
                        <li>At√© 100.000 visualiza√ß√µes/m√™s</li>
                        <li>At√© 25 funcion√°rios</li>
                        <li>At√© 100 GB de armazenamento</li>
                        <li>Suporte priorit√°rio</li>
                        <li>API personalizada</li>
                        <li>2 vCPU + 4 GB RAM</li>
                    </ul>
                </div>
                <div class="card-footer text-center">
                    <a href="{{ url_for('login') }}" class="btn btn-primary btn-lg w-100">
                        <i class="fas fa-crown me-2"></i>Escolher Professional
                    </a>
                </div>
            </div>
        </div>

        <!-- Plano Enterprise -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card pricing-card h-100">
                <div class="card-header text-center bg-dark text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-building text-info me-2"></i>Enterprise
                    </h4>
                    <p class="text-muted mb-0">Para grandes corpora√ß√µes</p>
                </div>
                <div class="card-body text-center">
                    <div class="plan-price mb-3">R$ 1.299</div>
                    <p class="text-muted">por m√™s</p>
                    <ul class="plan-features text-start">
                        <li>Projetos ilimitados</li>
                        <li>Camadas ilimitadas</li>
                        <li>Mapas p√∫blicos ilimitados</li>
                        <li>Visualiza√ß√µes ilimitadas</li>
                        <li>Funcion√°rios ilimitados</li>
                        <li>Armazenamento ilimitado</li>
                        <li>Suporte 24/7</li>
                        <li>API completa</li>
                        <li>Integra√ß√µes personalizadas</li>
                        <li>4 vCPU + 8 GB RAM</li>
                    </ul>
                </div>
                <div class="card-footer text-center">
                    <a href="{{ url_for('login') }}" class="btn btn-dark btn-lg w-100">
                        <i class="fas fa-phone me-2"></i>Falar com Vendas
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Se√ß√£o da Calculadora -->
    <div class="calculator-section">
        <div class="row">
            <div class="col-12 text-center mb-4">
                <h2 class="text-white">
                    <i class="fas fa-calculator me-3"></i>Calculadora Personalizada
                </h2>
                <p class="text-white-50">Calcule o pre√ßo exato para suas necessidades espec√≠ficas</p>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-body">
                        <form id="pricingForm">
                            <div class="row">
                                <!-- Coluna 1 -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="projects" class="form-label">
                                            <i class="fas fa-project-diagram text-primary me-2"></i>N√∫mero de Projetos
                                        </label>
                                        <input type="number" class="form-control" id="projects" min="0" value="5">
                                        <small class="form-text text-muted">Projetos para organizar suas camadas</small>
                                    </div>

                                    <div class="mb-3">
                                        <label for="layers" class="form-label">
                                            <i class="fas fa-layer-group text-success me-2"></i>N√∫mero de Camadas
                                        </label>
                                        <input type="number" class="form-control" id="layers" min="0" value="100">
                                        <small class="form-text text-muted">Shapefiles, GeoTIFFs, KMLs, etc.</small>
                                    </div>

                                    <div class="mb-3">
                                        <label for="public_maps" class="form-label">
                                            <i class="fas fa-globe-americas text-info me-2"></i>Mapas P√∫blicos
                                        </label>
                                        <input type="number" class="form-control" id="public_maps" min="0" value="10">
                                        <small class="form-text text-muted">Mapas compartilhados publicamente</small>
                                    </div>
                                </div>

                                <!-- Coluna 2 -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="page_views" class="form-label">
                                            <i class="fas fa-eye text-warning me-2"></i>Visualiza√ß√µes/M√™s
                                        </label>
                                        <input type="number" class="form-control" id="page_views" min="0" value="50000">
                                        <small class="form-text text-muted">Acessos aos mapas p√∫blicos</small>
                                    </div>

                                    <div class="mb-3">
                                        <label for="employees" class="form-label">
                                            <i class="fas fa-users text-secondary me-2"></i>Funcion√°rios Cadastrados
                                        </label>
                                        <input type="number" class="form-control" id="employees" min="0" value="15">
                                        <small class="form-text text-muted">Usu√°rios com acesso √† plataforma</small>
                                    </div>

                                    <div class="mb-3">
                                        <label for="server_usage" class="form-label">
                                            <i class="fas fa-server text-danger me-2"></i>Uso do Servidor (GB)
                                        </label>
                                        <input type="number" class="form-control" id="server_usage" min="0" step="0.1" value="50">
                                        <small class="form-text text-muted">Armazenamento + transfer√™ncia de dados</small>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-12 text-center">
                                    <button type="button" class="btn btn-primary btn-lg" onclick="calculatePrice()">
                                        <i class="fas fa-calculator me-2"></i>Calcular Pre√ßo
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary ms-2" onclick="resetForm()">
                                        <i class="fas fa-undo me-2"></i>Limpar
                                    </button>
                                </div>
                            </div>
                        </form>

                        <!-- Loading -->
                        <div id="pricing-loading" class="text-center mt-4" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Calculando...</span>
                            </div>
                            <p class="mt-2 text-muted">Calculando pre√ßos...</p>
                        </div>

                        <!-- Resultado -->
                        <div id="pricing-result" class="mt-4" style="display: none;">
                            <div class="result-card">
                                <div class="card-header bg-success text-white text-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-line me-2"></i>Resultado do C√°lculo
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <div class="border-end">
                                                <h6 class="text-muted">Pre√ßo Mensal</h6>
                                                <h3 class="text-success" id="total-price">R$ 0,00</h3>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="border-end">
                                                <h6 class="text-muted">Pre√ßo Anual</h6>
                                                <h4 class="text-info" id="annual-price">R$ 0,00</h4>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="border-end">
                                                <h6 class="text-muted">Margem Estimada</h6>
                                                <h4 class="text-warning" id="profit-margin">0%</h4>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-muted">ROI Estimado</h6>
                                            <h4 class="text-success">+233%</h4>
                                        </div>
                                    </div>

                                    <div class="mt-4">
                                        <div id="price-breakdown"></div>
                                    </div>

                                    <!-- Recomenda√ß√£o de Plano -->
                                    <div class="mt-4 text-center">
                                        <div id="plan-recommendation"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Se√ß√£o de Recursos -->
    <div class="row mt-5">
        <div class="col-12 text-center mb-4">
            <h2>
                <i class="fas fa-star me-2"></i>Por que escolher o WebGIS?
            </h2>
        </div>
        
        <div class="col-md-4 text-center mb-4">
            <div class="feature-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h4>Seguran√ßa</h4>
            <p class="text-muted">Infraestrutura segura com backup autom√°tico e criptografia de dados</p>
        </div>
        
        <div class="col-md-4 text-center mb-4">
            <div class="feature-icon">
                <i class="fas fa-tachometer-alt"></i>
            </div>
            <h4>Performance</h4>
            <p class="text-muted">Servidores de alta performance com 99.9% de uptime garantido</p>
        </div>
        
        <div class="col-md-4 text-center mb-4">
            <div class="feature-icon">
                <i class="fas fa-headset"></i>
            </div>
            <h4>Suporte</h4>
            <p class="text-muted">Equipe t√©cnica especializada dispon√≠vel para ajudar sua empresa</p>
        </div>
    </div>

    <!-- Se√ß√£o de Transpar√™ncia de Pre√ßos -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-calculator me-2"></i>Como Calculamos Nossos Pre√ßos
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>üíª Custos de Infraestrutura (Google Cloud)</h5>
                            <ul class="list-unstyled">
                                <li><strong>vCPU:</strong> US$ 32,49/m√™s por 1.000 horas</li>
                                <li><strong>RAM:</strong> US$ 3,59/m√™s por GiB</li>
                                <li><strong>Armazenamento:</strong> US$ 0,10/m√™s por GiB</li>
                            </ul>
                            <p class="text-muted small">* Pre√ßos baseados no GKE Autopilot do Google Cloud</p>
                        </div>
                        <div class="col-md-6">
                            <h5>üìä Nossa Estrutura de Pre√ßos</h5>
                            <ul class="list-unstyled">
                                <li><strong>Starter:</strong> 1 vCPU + 2GB RAM = ~R$ 199/m√™s</li>
                                <li><strong>Professional:</strong> 2 vCPU + 4GB RAM = ~R$ 499/m√™s</li>
                                <li><strong>Enterprise:</strong> 4 vCPU + 8GB RAM = ~R$ 1.299/m√™s</li>
                            </ul>
                            <p class="text-muted small">* Inclui margem para desenvolvimento, suporte e manuten√ß√£o</p>
                        </div>
                    </div>
                    
                    <div class="mt-3 p-3 bg-light rounded">
                        <h6><i class="fas fa-info-circle me-2"></i>Por que nossos pre√ßos s√£o competitivos?</h6>
                        <ul class="mb-0">
                            <li>Utilizamos infraestrutura de ponta do Google Cloud</li>
                            <li>Otimizamos recursos para m√°xima efici√™ncia</li>
                            <li>Oferecemos suporte t√©cnico especializado</li>
                            <li>Desenvolvimento cont√≠nuo de funcionalidades</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CTA Final -->
    <div class="row mt-5">
        <div class="col-12 text-center">
            <div class="card bg-primary text-white">
                <div class="card-body py-5">
                    <h2 class="mb-3">Pronto para come√ßar?</h2>
                    <p class="lead mb-4">Junte-se a centenas de empresas que j√° confiam no WebGIS</p>
                    <div class="d-flex gap-3 justify-content-center">
                        <a href="{{ url_for('login') }}" class="btn btn-light btn-lg">
                            <i class="fas fa-rocket me-2"></i>Come√ßar Agora
                        </a>
                        <a href="#calculator" class="btn btn-outline-light btn-lg">
                            <i class="fas fa-calculator me-2"></i>Calcular Pre√ßo
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para a Calculadora -->
<script>
async function calculatePrice() {
    console.log('Fun√ß√£o calculatePrice chamada');
    const form = document.getElementById('pricingForm');
    const resultDiv = document.getElementById('pricing-result');
    const loadingDiv = document.getElementById('pricing-loading');
    
    if (!form || !resultDiv || !loadingDiv) {
        console.error('Elementos n√£o encontrados:', { form, resultDiv, loadingDiv });
        alert('Erro: Elementos da calculadora n√£o encontrados');
        return;
    }
    
    // Mostrar loading
    loadingDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    
    const data = {
        projects: parseInt(document.getElementById('projects').value) || 0,
        layers: parseInt(document.getElementById('layers').value) || 0,
        public_maps: parseInt(document.getElementById('public_maps').value) || 0,
        page_views: parseInt(document.getElementById('page_views').value) || 0,
        employees: parseInt(document.getElementById('employees').value) || 0,
        server_usage: parseFloat(document.getElementById('server_usage').value) || 0
    };
    
    console.log('Dados para c√°lculo:', data);
    
    try {
        const response = await fetch('/api/pricing/calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        console.log('Resposta da API:', response);
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Resultado da API:', result);
        displayResult(result);
        
    } catch (error) {
        console.error('Erro na fun√ß√£o calculatePrice:', error);
        alert(`Erro ao calcular pre√ßos: ${error.message}`);
    } finally {
        loadingDiv.style.display = 'none';
    }
}

function displayResult(result) {
    console.log('Fun√ß√£o displayResult chamada com:', result);
    const totalPriceElement = document.getElementById('total-price');
    const breakdownElement = document.getElementById('price-breakdown');
    const resultDiv = document.getElementById('pricing-result');
    const planRecommendationElement = document.getElementById('plan-recommendation');
    
    if (!totalPriceElement || !breakdownElement || !resultDiv) {
        console.error('Elementos de resultado n√£o encontrados');
        return;
    }
    
    // Formatar pre√ßo total
    totalPriceElement.textContent = `R$ ${result.total_cost.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    
    // Atualizar pre√ßos anuais e margens
    const annualPrice = result.total_cost * 12;
    document.getElementById('annual-price').textContent = `R$ ${annualPrice.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    
    // Calcular margem estimada (assumindo 70% de margem)
    const estimatedProfit = result.total_cost * 0.7;
    const profitMargin = ((estimatedProfit / result.total_cost) * 100).toFixed(1);
    document.getElementById('profit-margin').textContent = `${profitMargin}%`;
    
    // Criar breakdown
    let breakdownHTML = '<h6>Detalhamento dos Custos:</h6>';
    
    const labels = {
        'projects': 'Projetos',
        'layers': 'Camadas', 
        'public_maps': 'Mapas P√∫blicos',
        'page_views': 'Visualiza√ß√µes',
        'employees': 'Funcion√°rios',
        'server_usage': 'Servidor'
    };
    
    for (const [key, item] of Object.entries(result.breakdown)) {
        if (item.weighted_cost > 0) {
            breakdownHTML += `
                <div class="breakdown-item">
                    <span><strong>${labels[key]}:</strong></span>
                    <span class="text-success">R$ ${item.weighted_cost.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                </div>
            `;
        }
    }
    
    breakdownElement.innerHTML = breakdownHTML;
    
    // Gerar recomenda√ß√£o de plano
    generatePlanRecommendation(result.total_cost, planRecommendationElement);
    
    resultDiv.style.display = 'block';
    console.log('Resultado exibido com sucesso');
}

function generatePlanRecommendation(totalCost, element) {
    let recommendation = '';
    let planClass = '';
    
    if (totalCost <= 400) {
        recommendation = 'Recomendamos o plano <strong>Starter</strong> para suas necessidades atuais.';
        planClass = 'text-success';
    } else if (totalCost <= 1200) {
        recommendation = 'Recomendamos o plano <strong>Professional</strong> para suas necessidades atuais.';
        planClass = 'text-primary';
    } else {
        recommendation = 'Recomendamos o plano <strong>Enterprise</strong> para suas necessidades atuais.';
        planClass = 'text-dark';
    }
    
    element.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-lightbulb me-2"></i>
            <span class="${planClass}">${recommendation}</span>
        </div>
    `;
}

function resetForm() {
    console.log('Fun√ß√£o resetForm chamada');
    document.getElementById('pricingForm').reset();
    document.getElementById('pricing-result').style.display = 'none';
    document.getElementById('pricing-loading').style.display = 'none';
    
    // Restaurar valores padr√£o
    document.getElementById('projects').value = '5';
    document.getElementById('layers').value = '100';
    document.getElementById('public_maps').value = '10';
    document.getElementById('page_views').value = '50000';
    document.getElementById('employees').value = '15';
    document.getElementById('server_usage').value = '50';
}

// Verificar se a calculadora est√° funcionando
document.addEventListener('DOMContentLoaded', function() {
    console.log('P√°gina de pre√ßos carregada, calculadora pronta!');
});
</script>
{% endblock %}
